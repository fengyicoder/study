# 音视频技术概述

帧率：FPS，每秒多少帧画面；以及Gop，表示多少秒一个I帧；

码流：编码器每秒编出的数据大小，单位是kbps；

分辨率：单位英寸中包含的像素点数，VGA：Video Graphics Array（视频图像分辨率）

音视频的未来展望：

1. 追求播放体验的超高清、高码率和高帧率；
2. 低延迟流媒体传输；
3. 新型媒体显示设备形态；



# 图像、像素与颜色空间

图像是一种在二维平面上通过排列像素来表达信息的数据组织形式，像素一般表示图像某个位置的亮度或色彩信息。



对于灰度图像，每个像素点上只有一个分量，即该点的亮度值。图像位深常见为8bit或10bit；

彩色图像则是每个像素点上包含多个分量，常见为RGB通道。



### 图像的颜色空间

颜色空间：彩色数据的表达方式，是一种利用整数区间来表达不同颜色的模型；

常见有以下颜色区间：

1. RGB颜色空间：由红绿蓝三基色构成的三维线性颜色空间；
2. YUV颜色空间：包括一个亮度分量Y跟两个色度分量，常见有YUV、NTSC以及Y'CrCb；



### 图像压缩编码

为了适应带宽需要对图像进行先压缩后传输，有以下两大类压缩方法：

- 无损压缩：压缩率较低，压缩后体积较大，没有信息损失，可通过压缩信息完全恢复原始信息；
- 有损压缩：压缩率较高，压缩后体积较小，有信息损失，无法完全还原原始信息；

无损压缩格式有TIFF、BMP、GIF和PNG等，主要使用基于预测或熵编码的算法；有损压缩格式有JPEG等，主要使用基于变换和量化编码的算法；



无损压缩编码中有以下两种编码方式：

- 游程编码：

  思路是使用数字+字符的方式来表示重复连续的数据，一般用于信息比较单一的数据，示例如下：

  AAAAABBCCCCCCDDAEE，可表示为5A2B6C1A2E；


- 哈夫曼编码：

  基于有序频率二叉树的编码方法，是可变长编码方式的一种，完全依赖码字出现的频率，是一种构造整体平均长度最短的编码方法，其关键步骤是构造复合哈夫曼编码规则的二叉树。哈夫曼树是一种特殊的二叉树，其叶子节点的个数与待编码的码元个数相同，每个叶子节点上都带有各自的权值。每个叶子节点的路径长度乘以该节点的权值总和即为整个二叉树的加权路径长度。在满足条件的各种二叉树中，路径长度最短的二叉树即为哈夫曼树，生成过程如图所示：

  ![哈夫曼树](C:\Users\user\Desktop\哈夫曼树.jpg)

  当访问左子树时，赋予码字0，访问右子树时赋予码字1。例如图示的哈夫曼树，其编码码表为：

  A:0000

  B:0001

  C:01

  D:1



常见的图像压缩编码格式：

1. BMP格式：可保存位深为1bit、4bit、8bit、16bit、24bit或32bit的图像；

2. JPEG格式：基于离散余弦变换的有损压缩编码格式，离散余弦变换具有以下的特点：变换后的频域能量分布与实际的图像信号更加吻合；更容易兼容硬件计算，运算更高效。变换公式如下：

   ${X_n} = \sum\limits_{k = 0}^{N - 1} {{C_k}{y_k}\cos \frac{{(2n + 1)k\pi }}{{2N}}} $

   其压缩步骤大致如下：将图像数据变换为YUV格式，并对两个亮度分量进行亚像素采样，生成4：2：0的图像数据；针对每个分量进行处理，裁成8*8大小的像素块，并使用离散余弦变换变换至值频域并进行量化；其直流分量经过DPCM编码，交流分量通过之字形扫描转换成一维数据再通过游程编码进行处理；处理后的数据采用熵编码生成压缩码流流出。



# 视频压缩编码

在视频压缩编码中，图像的颜色空间通常使用YCrCb颜色空间。

YUV像素格式与采样格式：Y代表亮度，UV分量代表色度，亮度与色度分量既可以一一对应，也可以对色度分量进行采样，常见的亚像素采样格式有4:4:4、4:2:2、4:2:0(4:1:1)。可如此采样的原因是人眼对亮度敏感，对色度不敏感。

常用的视频格式与分辨率：

原始图像数据需要转换为某种中间格式后才能进行编码和传输等后续操作，其中常用的格式如下：QCIF、CIF、4CIF/SD、HD/720P、FHD/1080P、UHD。



### 视频压缩编码基本原理

视频之所以可以压缩，主要在于其存在大量冗余信息：

- 时间冗余：视频相邻帧内容相似，存在运动关系；
- 空间冗余：视频某一帧内部相邻像素存在相似性；
- 编码冗余：视频中不同数据出现的概率不同；
- 视觉冗余：人的视觉系统对视频的不同内容敏感度不同；




预测编码：

预测编码是数据压缩中最常用的方法之一。在视频编码中，预测编码主要有两种方法：

- 帧内预测：利用图像内相邻像素的相似性去除冗余信息；
- 帧间预测：利用前后帧之间的相关性去除视频中的时间冗余；

帧间预测与帧内预测都需要将图像划分成像素子块再进行编码。帧内预测中像素子块需要获取已编码的相邻子块的参考信息再从预测模式中选择合适的预测模式进行编码，并将预测模式一并写到输出码流中。解码时根据已解码的像素子块与已知的预测模式来重建像素块。



帧间预测像素子块需要从已编码的参考帧中寻找最匹配的参考像素块，其中参考像素块到当前像素子块的偏移称为运动矢量。编码时会将参考帧的索引号和运动矢量编码到输出码流中，解码时通过运动矢量在参考帧中获取预测像素块。编码运动矢量通常不是编码运动矢量本身，而是将运动矢量分成运动矢量预测MVP与运动矢量残差MVD两部分，其中运动矢量预测是根据已编码的信息预测生成，运动矢量残差是通过熵编码写入到输出码流中。



变换编码：

变换编码的特性如下：

- 有利于利用人眼的特性，例如对空间域的图像数据进行频域变换可以有效的分离高优先级的直流或低频信号和低优先级的高频信号，对高频低频分别使用不同的参数进行压缩可有效压缩视频帧的数据量；
- 有利于利用图像与视频数据的能量特性。图像中的绝大部分信号能量集中在直流和低频区域，经过量化之后的高频分量变换系数大多为1或0；
- 相对于空间域图像信号中相邻的像素，变换到频域后系数之间的相关性明显降低。

简单概况下，实现了不同特征信息的解耦，分别处理可以大幅提高压缩率。



熵编码：

常用的熵编码方法有指数哥伦布编码（UVLC）算法、上下文自适应的变长编码（CAVLC）算法以及上下文自适应的二进制算术编码（CABAC）算法；



视频编码标准H.264：

在H.264编码过程中，每一帧的H图像都被分割成一个或多个条带，每个条带由多个宏块组成，一个宏块包含一个16\*16的亮度像素块以及两个8\*8像素的色度像素块以及其他宏块头信息。当对一个宏块编码时每个宏块都会被分割成多种不同大小的子块进行预测。帧内预测的块大小可能为16\*16像素或者4\*4像素，帧间预测或运动补偿的块有7种不同的形状：16\*16，16\*8，8\*16，8\*8，8\*4，4\*8和4\*4像素大小。

在H.264中，熵编码算法主要有上下文自适应的变长编码和上下文自适应的二进制算术编码。

H.264的条带具有不同的类型，最常用的有I条带、P条带和B条带：

- I条带：帧内编码条带，只包含I宏块；
- P条带：单向帧间编码条带，可能包含P宏块和I宏块；
- B条带：双向帧间编码条带，可能包含B宏块和I宏块；

H.264的基本算法：

1. 帧内预测：基于像素块的帧内预测技术，如下：
   - 16\*16像素的亮度块：4种预测模式；
   - 4\*4像素的亮度块：9种预测模式；
   - 色度块：4种预测模式；
2. 帧间预测：基于块的运动估计和补偿方法



高效视频编码标准H.265：

在4K或8K的超高清视频中，若采用H.264的编码方式会导致过多的宏块产生，降低压缩效率。为了解决这个问题，H.265提出树形编码单元这一图像帧分割方式。一个树形编码单元的大小为64\*64像素，并且可以根据其中的内容进行四叉树形的分割。每个树形编码单元包括3个树形编码块，即1个亮度树形编码块和2个色度树形编码块。



# 音频压缩编码

当物体振动时物体所在的介质被激发，其分子随之有规律的振动，造成其分布的疏密变化进而产生向四面八方传播的纵波，这就是声音的产生和传播。

声音信息的基本要素：

振幅、频率跟音色。其中振幅体现了声音的能量大小，振幅越大音量越高，振幅越低音量越低；频率使声音产生音调的变化，频率越高音调越高，越低则音调越低。通常物体振动的频率与振动长度、粗细、密度和厚度成反比。另外，人的听觉只能感知一定频率范围内的声音，为20Hz-20kHz，超过20kHz的声音称为超声波，低于20Hz的声音称为次声波。音色是人对声音的一种感知，世界上绝大多数的声音都是频率不同强度不同声音的叠加，其中强度最大的频率分量由声源主体产生，称为“基音”，其他部分振动产生的频率不同、强度略低的分量称为“泛音”，声音的音色主要由泛音的特性决定。

## 音频信息采样与数字化

模拟音频数字化的过程主要包括采样和量化两个步骤。

音频采样：

根据奈奎斯特采样定理，信号的采样频率必须超过最高频率分量的2倍以上，否则将出现混叠现象产生采样失真。因为人耳所听范围约为20Hz-20kHz，所以对音频信号的采样频率通常超过40kHz，实践中常采用44.1kHz。

采样点量化：

量化是为了将声音信号更好的数字化，通常所采用的位深为4bit、8bit或32bit。

脉冲编码调制：

脉冲编码调制其核心思路是对量化产生的多进制电位进行进一步编码，统一以二进制电平的形式传输。具体操作如下：

1. PCM量化区间分割

   在操作之前需要进行归一化处理，将每个采样信号的幅值绝对值限定在[0,1]区间内，之后采用低半区二等分的方式进行非均匀分割，如下所示：

   ![PCM区间分割](C:\Users\user\Desktop\PCM区间分割.jpg)

   循环分割低半区，共分割7次，得到8个子区间。

   另一方面对输出进行八等分，构造量化输入与输出关系，加上负区间，如图所示：

   ![img](file:///C:/Users/user/Documents/WXWork/1688851340921467/Cache/Image/2022-02/f055016cb27d1482a98b58bbe2555dca.jpg)

   总共包含16段折线，由于原点附近的四段折线斜率相同，因此可视为一条折线，所以总共有13条折线，因此PCM量化编码方法也被称为A律13折线法。

2. PCM量化编码规则

   假设使用8bit位深进行编码，其中b0位极性码，表示电平的正负极性，b1b2b3为段落码，对应正电平或负电平的八段区间，b4b5b6b7代表段内码，表示在区间内的具体取值。

